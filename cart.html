<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Review Your Order â€” Mingle Bistro</title>

<style>
:root{
  --gold:#D4AF37;
  --bg:#0e0e0e;
  --card:#141414;
  --muted:#bbbbbb;
  --border:rgba(255,255,255,0.05);
}

/* Base */
*{box-sizing:border-box}
body{
  background:var(--bg);
  margin:0;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
}

/* HEADER */
.header{
  padding:18px 14px;
  text-align:center;
  border-bottom:1px solid var(--border);
}
.header-title{
  font-size:20px;
  font-weight:800;
  color:var(--gold);
  letter-spacing:0.3px;
}

/* Container */
.container{padding:16px;max-width:850px;margin:0 auto;}

/* Empty Cart */
.empty{
  padding:40px 12px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:12px;
  background:rgba(255,255,255,0.02);
}
.empty .emoji{font-size:42px;margin-bottom:12px}
.empty button{
  padding:12px 18px;
  border-radius:10px;
  border:1px solid var(--gold);
  background:var(--gold);
  color:black;
  font-weight:800;
  cursor:pointer;
}

/* Cart list */
.cart-item{
  display:flex;
  gap:12px;
  background:var(--card);
  border:1px solid var(--border);
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
}

.item-left{flex:1}
.item-name{font-size:15px;font-weight:800;color:#fff}
.item-meta{color:var(--muted);font-size:13px;margin-top:6px;white-space:pre-line}

/* Right column */
.item-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
}

/* Qty + remove row */
.qty-row{
  display:flex;
  align-items:center;
  gap:6px;
}

/* Premium qty buttons */
.qty-btn{
  width:34px;
  height:34px;
  border-radius:10px;
  border:1px solid var(--gold);
  background:transparent;
  color:var(--gold);
  font-size:18px;
  font-weight:800;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
}
.qty-val{
  min-width:28px;
  text-align:center;
  font-weight:800;
}

/* remove button */
.remove-btn{
  border:none;
  background:transparent;
  padding:6px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.remove-btn svg{
  pointer-events:none;
}

/* Price (small) */
.item-price{
  font-size:13px;
  color:var(--muted);
  font-weight:800;
}

/* Charges + totals */
.summary-box{
  margin-top:16px;
  padding:14px;
  border-radius:10px;
  background:rgba(255,255,255,0.02);
  border:1px solid var(--border);
}

.summary-line{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  font-size:14px;
  color:var(--muted);
}
.summary-line.total{
  font-size:18px;
  font-weight:900;
  color:var(--gold);
}

/* Buttons */
.actions{
  margin-top:18px;
  text-align:center;
}

.btn-primary{
  width:100%;
  padding:14px;
  background:var(--gold);
  color:#000;
  border:1px solid var(--gold);
  border-radius:12px;
  font-weight:900;
  font-size:15px;
  cursor:pointer;
}

.btn-secondary{
  margin-top:10px;
  width:100%;
  padding:12px;
  background:transparent;
  border:1px solid var(--border);
  color:#ddd;
  border-radius:12px;
  cursor:pointer;
}

/* Success overlay */
#successOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  justify-content:center;
  align-items:center;
  padding:16px;
  z-index:5000;
}

.success-card{
  width:100%;
  max-width:520px;
  background:#111;
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px;
}

.order-title{
  font-size:20px;
  font-weight:900;
  color:var(--gold);
}
.order-time{font-size:13px;color:var(--muted);margin-top:4px}

.success-item{
  margin-top:12px;
  display:flex;
  justify-content:space-between;
  color:#ddd;
}
.success-meta{
  color:var(--muted);
  font-size:13px;
  margin-left:4px;
}

/* Close buttons */
.success-buttons{
  margin-top:18px;
  display:flex;
  gap:10px;
  justify-content:flex-end;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">Review Your Order</div>
</div>

<div class="container">

  <!-- EMPTY STATE -->
  <div id="emptyState" class="empty" style="display:none;">
    <div class="emoji">ðŸ›’</div>
    <div style="font-weight:800;font-size:16px;margin-bottom:6px">Your basket is empty</div>
    <button onclick="location.href='sharing_plates.html'">Continue Ordering</button>
  </div>

  <!-- CART ITEMS -->
  <div id="cartList"></div>

  <!-- SUMMARY -->
  <div id="summaryBox" class="summary-box" style="display:none;">
    <div class="summary-line">
      <span>Subtotal</span>
      <span id="sumSubtotal">$0.00</span>
    </div>
    <div class="summary-line">
      <span>Service Charge (10%)</span>
      <span id="sumService">$0.00</span>
    </div>
    <div class="summary-line">
      <span>GST (9%)</span>
      <span id="sumGST">$0.00</span>
    </div>
    <div class="summary-line total">
      <span>Grand Total</span>
      <span id="sumTotal">$0.00</span>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions" id="actionButtons" style="display:none;">
    <button class="btn-primary" onclick="placeOrder()">Place Order</button>
    <button class="btn-secondary" onclick="location.href='sharing_plates.html'">
      Continue Ordering
    </button>
    <button class="btn-secondary" onclick="clearCart()">Clear Cart</button>
  </div>

</div>

<!-- SUCCESS OVERLAY -->
<div id="successOverlay">
  <div class="success-card">
    <div class="order-title" id="orderNumber">Order #0000</div>
    <div class="order-time" id="orderTime"></div>

    <div id="successList"></div>

    <div class="success-buttons">
      <button class="btn-secondary" onclick="closeSuccess()">Close</button>
      <button class="btn-primary" onclick="location.href='sharing_plates.html'">Continue Ordering</button>
    </div>
  </div>
</div>

<script>
function getCart(){
  try{
    const raw = localStorage.getItem("cart");
    if(!raw) return [];

    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed)) return [];

    return parsed.map(normalizeCartItem);
  }catch(e){
    localStorage.removeItem("cart");
    return [];
  }
}

function saveCart(c){
  try{
    localStorage.setItem("cart", JSON.stringify(c));
  }catch(e){
    console.warn("Safari storage blocked, cart not persisted", e);
  }
}
/* ================= PROMOTION ENGINE (CART PAGE) ================= */

const PROMO_PRICE = 12;
const PROMO_IDS = ['salmon', 'octopus', 'oysters'];

/* Detect beverage items */
function isBeverageItem(it){
  return it.type === 'drink' || it.category === 'beverage';
}

/* Normalize ID from item name */
function getItemId(it){
  return (it.id || it.name || "")
    .toLowerCase();
}

/* Apply promo pricing strictly */
function applyPromotions(cart){
  let drinkCount = 0;

  cart.forEach(it=>{
    if(isBeverageItem(it)) drinkCount += it.qty;
  });

  let promoAvailable = drinkCount;

  cart.forEach(it=>{
    const id = getItemId(it);
    const eligible = PROMO_IDS.some(p => id.includes(p));

    /* store original price once */
    if(it.basePrice == null){
      it.basePrice = Number(it.unitPrice ?? it.price);
    }

    if(eligible && promoAvailable > 0){
      it.unitPrice = PROMO_PRICE;
      it.promoApplied = true;
      promoAvailable--;
    } else {
      it.unitPrice = it.basePrice;
      it.promoApplied = false;
    }
  });

  return cart;
}


function clearCart(){   try{ localStorage.removeItem("cart"); }catch(e){}   renderCart(); }

/* Render Cart */
function renderCart(){
  let cart = getCart();
  
  
  // saveCart(cart); // âŒ do NOT write during render (Safari-safe)
  const wrap = document.getElementById("cartList");
  const summary = document.getElementById("summaryBox");
  const actions = document.getElementById("actionButtons");
  const emptyState = document.getElementById("emptyState");

  wrap.innerHTML = "";

  if(cart.length === 0){
    emptyState.style.display = "block";
    summary.style.display = "none";
    actions.style.display = "none";
    return;
  }

  emptyState.style.display = "none";
  summary.style.display = "block";
  actions.style.display = "block";

  let subtotal = 0;

  cart.forEach((it, idx)=>{
    const price = it.promoApplied ? PROMO_PRICE : (it.unitPrice ?? it.price);
    subtotal += price * it.qty;

    const row = document.createElement("div");
    row.className = "cart-item";

    const left = document.createElement("div");
    left.className = "item-left";

    const name = document.createElement("div");
    name.className = "item-name";
    let displayName = it.name
      .replace(/\s*\(.*?\)\s*/g, "")
      .replace(/\s*â€”\s*.*$/g, "");
    
    /* PREFIX TEMPERATURE */
    if(it.option && (it.option.includes("Hot") || it.option.includes("Ice"))){
      const temp = it.option.includes("Ice") ? "Ice" : "Hot";
      displayName = temp + " " + displayName;
    }
    
    const pizzaParts = (it.category === "pizza" && displayName.includes("/"))
      ? displayName.split("/").map(p => p.trim())
      : null;
    
    name.textContent = pizzaParts ? pizzaParts[0] : displayName;    
    
    const meta = document.createElement("div");
    meta.className = "item-meta";

    const lines = [];

    /* PASTA FORMAT */
    if(it.pastaType){
      if(it.size && it.size.label){
        lines.push(`${it.pastaType} - ${it.size.label}`);
      } else {
        lines.push(it.pastaType);
      }
    }
    
    /* ADD ONS */
    if(it.addons && it.addons.length){
      it.addons.forEach(a => lines.push(`+${a.name}`));
    }
    
    /* HOT STONE PIZZA (FULL / HALF & HALF) */
    if (it.category === "pizza" && pizzaParts && pizzaParts[1]) {
      lines.push("Half: " + pizzaParts[1]);
    }
  
  
    /* OPTIONS DISPLAY (CHECKOUT ONLY) */

    if (
      typeof it.option === "string" &&
      it.option.trim() !== "" &&
      !it.option.includes("Hot") &&
      !it.option.includes("Ice")
    ){
      lines.push(it.option);
    }
    
    // FRIES
    if (typeof it.fries === "string" && it.fries.trim() !== "") {
      lines.push("Fries: " + it.fries);
    }
    
    // SPICE
    if (typeof it.spicy === "string" && it.spicy.trim() !== "") {
      lines.push("Spice: " + (it.spicy === "non-spicy" ? "Non-Spicy" : "Spicy"));
    }
    
    // DONENESS
    if (typeof it.doneness === "string" && it.doneness.trim() !== "") {
      lines.push("Doneness: " + it.doneness);
    }


    /* SPECIAL REQUEST */
    if(it.request) lines.push("Special: " + it.request);
    
    meta.textContent = lines.join("\n");

    left.appendChild(name);
    left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "item-right";

    const itemPrice = document.createElement("div");
    itemPrice.className = "item-price";
    itemPrice.textContent = "$" + ((it.unitPrice ?? it.price) * it.qty).toFixed(2);

    const qty = document.createElement("div");
    qty.className = "qty-row";

    const minus = document.createElement("button");
    minus.className = "qty-btn";
    minus.textContent = "âˆ’";
    minus.onclick = ()=>updateQty(idx, -1);

    const val = document.createElement("div");
    val.className = "qty-val";
    val.textContent = it.qty;

    const plus = document.createElement("button");
    plus.className = "qty-btn";
    plus.textContent="ï¼‹";
    plus.onclick = ()=>updateQty(idx, 1);

    const remove = document.createElement("button");
    remove.className = "remove-btn";

    remove.innerHTML = `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
           stroke="var(--gold)" stroke-width="2" stroke-linecap="round"
           stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-1 14H6L5 6m5 0V4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    `;

    remove.onclick = ()=>removeItem(idx);

    qty.append(minus,val,plus,remove);

    right.append(itemPrice, qty);

    row.append(left, right);
    wrap.appendChild(row);
  });

  const service = subtotal * 0.10;
  const gst = (subtotal + service) * 0.09;
  const total = subtotal + service + gst;

  document.getElementById("sumSubtotal").textContent = "$" + subtotal.toFixed(2);
  document.getElementById("sumService").textContent = "$" + service.toFixed(2);
  document.getElementById("sumGST").textContent = "$" + gst.toFixed(2);
  document.getElementById("sumTotal").textContent = "$" + total.toFixed(2);
}

/* Update quantity */
function updateQty(idx,delta){
  const cart = getCart();
  cart[idx].qty += delta;
  if(cart[idx].qty < 1) cart[idx].qty = 1;
  saveCart(cart);
  renderCart();
}

/* Remove item */
function removeItem(idx){
  const cart = getCart();
  cart.splice(idx,1);
  saveCart(cart);
  renderCart();
}

/* Place order */
function placeOrder(){
  const cart = getCart();
  if(cart.length===0) return;

  const id = "MB" + Math.floor(1000 + Math.random()*9000);
  const ts = new Date();
  const tsReadable = ts.toLocaleString();

  document.getElementById("orderNumber").textContent = "Order #" + id;
  document.getElementById("orderTime").textContent = tsReadable;

  const list = document.getElementById("successList");
  list.innerHTML = "";

  let subtotal = 0;

  cart.forEach(it=>{
    subtotal += (Number(it.unitPrice ?? it.price) || 0) * (Number(it.qty) || 1);
  });

  const service = subtotal * 0.10;
  const gst = (subtotal + service) * 0.09;
  const total = subtotal + service + gst;

  cart.forEach(it=>{
    const div = document.createElement("div");
    div.className = "success-item";
    div.innerHTML = `
      <div>x ${it.qty} ${it.name}</div>
      <div>$${((it.unitPrice ?? it.price) * it.qty).toFixed(2)}</div>
    `;
    list.appendChild(div);

    if(
      it.prosciutto || it.fries || it.spicy || it.doneness ||
      it.size || (it.addons && it.addons.length) || it.request
    ){
      const meta = document.createElement("div");
      meta.className = "success-meta";
      const parts = [];

      if(it.prosciutto) parts.push("Option: " + it.prosciutto);
      if(it.fries) parts.push("Fries: " + it.fries);
      if(it.spicy) parts.push("Spice: " + (it.spicy==="non-spicy"?"Non-Spicy":"Spicy"));
      if(it.doneness) parts.push("Doneness: " + it.doneness);
      if(it.size) parts.push(it.size.label);
      if(it.addons && it.addons.length){
        it.addons.forEach(a => parts.push("+ " + a.name));
      }
      if(it.pastaType && it.category !== "pizza"){
        parts.push(it.pastaType);
      }
      if(it.request) parts.push("Special: " + it.request);

      meta.textContent = parts.join(" â€¢ ");
      list.appendChild(meta);
    }
  });

  const totalsBlock = document.createElement("div");
  totalsBlock.style.marginTop = "12px";
  totalsBlock.style.borderTop = "1px solid rgba(255,255,255,0.04)";
  totalsBlock.style.paddingTop = "10px";
  totalsBlock.innerHTML = `
    <div style="display:flex;justify-content:space-between;color:#ddd">
      <div>Subtotal</div><div>$${subtotal.toFixed(2)}</div>
    </div>
    <div style="display:flex;justify-content:space-between;color:#ddd;margin-top:6px">
      <div>Service (10%)</div><div>$${service.toFixed(2)}</div>
    </div>
    <div style="display:flex;justify-content:space-between;color:#ddd;margin-top:6px">
      <div>GST (9%)</div><div>$${gst.toFixed(2)}</div>
    </div>
    <div style="display:flex;justify-content:space-between;color:var(--gold);font-weight:900;margin-top:8px">
      <div>Total</div><div>$${total.toFixed(2)}</div>
    </div>
  `;
  list.appendChild(totalsBlock);

  document.getElementById("successOverlay").style.display = "flex";

  const orders = JSON.parse(localStorage.getItem("orders") || "[]");
  orders.unshift({ id, created: ts.toISOString(), readable: tsReadable, items: cart.slice(), subtotal, service, gst, total });
  localStorage.setItem("orders", JSON.stringify(orders));

  clearCart();
}

/* Close */
function closeSuccess(){
  document.getElementById("successOverlay").style.display="none";
}

/* Init */
renderCart();

</script>

</body>
</html>